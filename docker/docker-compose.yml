# Phase 1: PostgreSQL (pgvector), Neo4j, Redis, and app test runner
# All settings read from ../.env; see .env.example for Docker infrastructure and app/api vars.
services:
  postgres:
    image: pgvector/pgvector:pg16
    env_file:
      - ../.env
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-memory}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-memory}
      POSTGRES_DB: ${POSTGRES_DB:-memory}
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-memory} -d ${POSTGRES_DB:-memory}"]
      interval: 2s
      timeout: 5s
      retries: 10

  neo4j:
    image: neo4j:5
    env_file:
      - ../.env
    environment:
      NEO4J_AUTH: ${NEO4J_AUTH:-${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-password}}
    ports:
      - "7474:7474"
      - "7687:7687"
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -a bolt://localhost:7687 -u ${NEO4J_USER:-neo4j} -p ${NEO4J_PASSWORD:-password} 'RETURN 1' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 18
      start_period: 90s

  redis:
    image: redis:7-alpine
    env_file:
      - ../.env
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 3s
      retries: 5

  # App (test runner). Connection vars built from POSTGRES_*, NEO4J_USER/NEO4J_PASSWORD so container and app stay in sync. Rest from ../.env (e.g. EMBEDDING_INTERNAL__BASE_URL for Ollama on host).
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: test
    env_file:
      - ../.env
    environment:
      DATABASE__POSTGRES_URL: postgresql+asyncpg://${POSTGRES_USER:-memory}:${POSTGRES_PASSWORD:-memory}@postgres:5432/${POSTGRES_DB:-memory}
      DATABASE__NEO4J_URL: bolt://neo4j:7687
      DATABASE__NEO4J_USER: ${NEO4J_USER:-neo4j}
      DATABASE__NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password}
      DATABASE__NEO4J_BROWSER_URL: bolt://localhost:7687
      DATABASE__REDIS_URL: redis://redis:6379
      EMBEDDING_INTERNAL__PROVIDER: ${EMBEDDING_INTERNAL__PROVIDER:-openai}
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: sh -c "alembic upgrade head && pytest tests packages/py-cml/tests -v --tb=short"

  # API server (Phase 9). Connection vars built from POSTGRES_*, NEO4J_USER/NEO4J_PASSWORD so container and app stay in sync. Rest from ../.env. Run: docker compose up api (after building).
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: production
    env_file:
      - ../.env
    environment:
      DATABASE__POSTGRES_URL: postgresql+asyncpg://${POSTGRES_USER:-memory}:${POSTGRES_PASSWORD:-memory}@postgres:5432/${POSTGRES_DB:-memory}
      DATABASE__NEO4J_URL: bolt://neo4j:7687
      DATABASE__NEO4J_USER: ${NEO4J_USER:-neo4j}
      DATABASE__NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password}
      DATABASE__NEO4J_BROWSER_URL: bolt://localhost:7687
      DATABASE__REDIS_URL: redis://redis:6379
      # Default to openai so API starts without sentence-transformers; set EMBEDDING_INTERNAL__PROVIDER=local in .env for local embeddings.
      EMBEDDING_INTERNAL__PROVIDER: ${EMBEDDING_INTERNAL__PROVIDER:-openai}
      # Pass CI markers through so startup LLM validation can auto-skip in GitHub Actions.
      CI: ${CI:-}
      GITHUB_ACTIONS: ${GITHUB_ACTIONS:-}
      LLM_STARTUP_VALIDATION_ENABLED: ${LLM_STARTUP_VALIDATION_ENABLED:-true}
      LLM_STARTUP_VALIDATE_IN_CI: ${LLM_STARTUP_VALIDATE_IN_CI:-false}
      LLM_STARTUP_VALIDATION_TIMEOUT_SEC: ${LLM_STARTUP_VALIDATION_TIMEOUT_SEC:-3}
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8000:8000"
    command: sh -c "python scripts/validate_llm_endpoints.py && alembic upgrade head && uvicorn src.api.app:app --host 0.0.0.0 --port 8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
